{%- set n_groups = sprite.dim_groups.keys()|length == 1 -%}

{%- macro dimensions(icon) %}
  width: {{ icon.css('width') }};
  height: {{ icon.css('height') }};
{% endmacro -%}

{%- macro bkg_image(icon) -%}
{%- set icon=icon.png if png else icon -%}
{%- if data -%}
  {%- set url=icon.data_URI() -%}
{%- else -%}
  {%- set url=url_dir + '/' + icon.filename -%}
{%- endif -%}
background-image: url({{ url }});
{%- endmacro -%}

{#- General declaration for background and dimensions if possible -#}
{%- if common_class -%}
.{{ common_class }}
{%- else -%}
  {%- for icon in sprite.icons -%}
    {{ icon.css_selector() }}
	  {%- if not loop.last -%}, {% endif -%}
  {%- endfor %}
{%- endif %} {
  {%- if not as_icons %}
  {{ bkg_image(sprite) }}
  {%- endif %}
  background-repeat: no-repeat;
  {%- if n_groups == 1 %}
  {#- only one dimension group, include dimensions here -#}
  {{ dimensions(sprite.icons[0]) }}
  {%- endif -%}
}
{% for group in sprite.dim_groups.values() -%}
{%- if group|length > 1 and n_groups > 1 -%}
{#- width and height properties can be grouped -#}
{#- if there is only one group, it has already been done above -#}
{%- for icon in group -%}
  {{ icon.css_selector() }}
  {%- if not loop.last %}, {% endif -%}
{%- endfor %} {
  {{ dimensions(sprite.icons[0]) }}
}
{%- endif -%}

{#- now define positions, individually -#}

{% for icon in group %}
{{ icon.css_selector() }} {
  {%- if as_icons %}
  {{ bkg_image(icon) }}
  {%- endif %}
  background-position: {{ icon.css('background-position') }};
  {%- if group|length == 1 %}
  {{- dimensions(icon) -}}
  {%- endif %}
}
{% endfor %}
{%- endfor %}
